<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Matricular Estudiante - CEFORSEG</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
.camera-box{
  position:relative;
  width:100%;
  padding-top:133%;
  background:#000;
  border-radius:10px;
  overflow:hidden;
  border:2px solid #0a3b78;
}
.camera-box video,
.camera-box img{
  position:absolute;
  top:0;left:0;
  width:100%;
  height:100%;
  object-fit:cover;
}
</style>
</head>

<body>

<script>
if(!localStorage.getItem('token')){
  location.href='/login';
}
</script>

<div id="app"></div>

<script>
const token = localStorage.getItem('token');

fetch('/layout.html')
  .then(r=>r.text())
  .then(html=>{
    document.getElementById('app').innerHTML = html;
    const content = document.querySelector('.content');

    content.innerHTML = `
      <h3 class="mb-4">üì∏ Matricular Estudiante</h3>

      <form id="formMatricula" enctype="multipart/form-data">

        <div class="row g-3">

          <div class="col-md-8">
            <div class="card shadow-sm">
              <div class="card-body">

                <div class="row g-2">
                  <div class="col-md-6">
                    <input class="form-control" name="nombre" placeholder="Nombre completo" required>
                  </div>
                  <div class="col-md-6">
                    <input class="form-control" name="cedula" placeholder="C√©dula" required>
                  </div>
                  <div class="col-md-6">
                    <input class="form-control" name="telefono" placeholder="Tel√©fono">
                  </div>
                  <div class="col-md-6">
                    <input class="form-control" name="ciudad" placeholder="Ciudad">
                  </div>
                  <div class="col-12">
                    <input class="form-control" name="direccion" placeholder="Direcci√≥n">
                  </div>
                </div>

                <hr>
                <h6 class="mb-2">üìö Cursos a matricular</h6>
                <div id="listaCursos" class="ms-2"></div>

              </div>
            </div>
          </div>

          <div class="col-md-4">
            <div class="card shadow-sm">
              <div class="card-body text-center">

                <div class="camera-box mb-2">
                  <video id="video" autoplay></video>
                  <img id="preview" class="d-none">
                </div>

                <button type="button" class="btn btn-warning w-100 mb-2" onclick="tomarFoto()">
                  üì∑ Tomar foto
                </button>

                <input type="file" name="foto" id="foto" class="d-none">
                <div class="text-danger small d-none" id="msgFoto">
                  ‚ö†Ô∏è La foto es obligatoria
                </div>

              </div>
            </div>
          </div>

        </div>

        <button class="btn btn-primary w-100 mt-4">
          ‚úÖ Matricular Estudiante
        </button>

      </form>
    `;

    iniciarCamara();
    cargarCursos();
    registrarSubmit();
  });

/* üé• C√°mara */
function iniciarCamara(){
  const v = document.getElementById('video');
  navigator.mediaDevices.getUserMedia({ video:true })
    .then(stream => v.srcObject = stream)
    .catch(()=>alert('No se pudo acceder a la c√°mara'));
}

/* üì∏ Foto */
function tomarFoto(){
  const v = document.getElementById('video');
  const canvas = document.createElement('canvas');
  canvas.width = v.videoWidth;
  canvas.height = v.videoHeight;
  canvas.getContext('2d').drawImage(v,0,0);

  canvas.toBlob(blob=>{
    const file = new File([blob],'foto.jpg',{type:'image/jpeg'});
    const dt = new DataTransfer();
    dt.items.add(file);
    document.getElementById('foto').files = dt.files;

    const img = document.getElementById('preview');
    img.src = URL.createObjectURL(blob);
    img.classList.remove('d-none');
    document.getElementById('msgFoto').classList.add('d-none');
  });
}

/* üìö Cursos (CHECKBOX) */
async function cargarCursos(){
  const res = await fetch('/api/cursos',{
    headers:{ Authorization:'Bearer '+token }
  });
  const cursos = await res.json();
  const cont = document.getElementById('listaCursos');

  cursos.forEach(c=>{
    cont.innerHTML += `
      <div class="form-check">
        <input class="form-check-input" type="checkbox" name="curso_ids[]" value="${c.id}" id="curso_${c.id}">
        <label class="form-check-label" for="curso_${c.id}">
          ${c.nombre} - $${Number(c.precio).toLocaleString()}
        </label>
      </div>
    `;
  });
}

/* üöÄ Submit */
function registrarSubmit(){
  document.getElementById('formMatricula').addEventListener('submit', async e=>{
    e.preventDefault();

    if(!document.getElementById('foto').files.length){
      document.getElementById('msgFoto').classList.remove('d-none');
      return;
    }

    const formData = new FormData(e.target);

    const res = await fetch('/api/estudiantes',{
      method:'POST',
      headers:{ Authorization:'Bearer '+token },
      body:formData
    });

    const data = await res.json();
    alert(data.mensaje);
    location.href='/estudiantes-panel';
  });
}
</script>

</body>
</html>
