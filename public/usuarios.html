<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Usuarios - CEFORSEG</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>

<script>
// üîí SOLO GERENTE
if(localStorage.getItem('rol') !== 'gerente'){
  location.href = '/dashboard';
}
if(!localStorage.getItem('token')){
  location.href = '/login';
}
</script>

<div id="app"></div>

<script>
const token = localStorage.getItem('token');

fetch('/layout.html')
  .then(r => r.text())
  .then(html => {
    document.getElementById('app').innerHTML = html;
    const content = document.querySelector('.content');

    content.innerHTML = `
      <h3 class="mb-4">üë§ Gesti√≥n de Usuarios</h3>

      <div class="card mb-4 shadow-sm">
        <div class="card-body">
          <h6 class="mb-3">Crear nuevo usuario</h6>

          <form id="formUsuario">
            <div class="row g-3">
              <div class="col-md-4">
                <input id="usuario" class="form-control" placeholder="Usuario" required>
              </div>
              <div class="col-md-4">
                <input id="password" type="password" class="form-control" placeholder="Contrase√±a" required>
              </div>
              <div class="col-md-4">
                <select id="rol" class="form-select" required>
                  <option value="">Rol</option>
                  <option value="secretaria">Secretaria</option>
                  <option value="gerente">Gerente</option>
                </select>
              </div>
            </div>

            <button class="btn btn-primary mt-3">Crear usuario</button>
          </form>
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-body p-0">
          <table class="table table-striped mb-0 align-middle text-center">
            <thead class="table-dark">
              <tr>
                <th>ID</th>
                <th>Usuario</th>
                <th>Rol</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="tablaUsuarios"></tbody>
          </table>
        </div>
      </div>
    `;

    cargarUsuarios();
    registrarFormulario();
  });

/* üîÑ LISTAR USUARIOS */
async function cargarUsuarios(){
  const res = await fetch('/api/usuarios', {
    headers:{ Authorization:'Bearer '+token }
  });
  const usuarios = await res.json();
  const tabla = document.getElementById('tablaUsuarios');
  tabla.innerHTML = '';

  usuarios.forEach(u => {
    const eliminar =
      u.rol === 'gerente'
        ? '<span class="text-muted">‚Äî</span>'
        : `<button class="btn btn-danger btn-sm" onclick="eliminarUsuario(${u.id})">Eliminar</button>`;

    tabla.innerHTML += `
      <tr>
        <td>${u.id}</td>
        <td>${u.usuario}</td>
        <td>${u.rol}</td>
        <td>${eliminar}</td>
      </tr>
    `;
  });
}

/* ‚ûï CREAR USUARIO */
function registrarFormulario(){
  document.getElementById('formUsuario').addEventListener('submit', async e=>{
    e.preventDefault();

    const usuario = document.getElementById('usuario').value;
    const password = document.getElementById('password').value;
    const rol = document.getElementById('rol').value;

    const res = await fetch('/api/usuarios', {
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'Authorization':'Bearer '+token
      },
      body: JSON.stringify({ usuario, password, rol })
    });

    const data = await res.json();
    alert(data.mensaje);

    e.target.reset();
    cargarUsuarios();
  });
}

/* ‚ùå ELIMINAR */
async function eliminarUsuario(id){
  if(!confirm('¬øEliminar este usuario?')) return;

  const res = await fetch('/api/usuarios/'+id, {
    method:'DELETE',
    headers:{ Authorization:'Bearer '+token }
  });

  const data = await res.json();
  alert(data.mensaje);
  cargarUsuarios();
}
</script>

</body>
</html>
