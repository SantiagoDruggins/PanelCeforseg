<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Ficha del Estudiante</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

<div class="container mt-4">

  <a href="/estudiantes-panel" class="btn btn-secondary mb-3">â¬… Volver</a>

  <div class="card mb-4">
    <div class="card-body row">
      <div class="col-md-4 text-center">
        <img id="foto" class="img-fluid rounded shadow" style="max-height:300px">
      </div>
      <div class="col-md-8">
        <h3 id="nombre"></h3>
        <p><b>CÃ©dula:</b> <span id="cedula"></span></p>
        <p><b>Curso:</b> <span id="curso"></span></p>
        <p><b>Precio:</b> $<span id="precio"></span></p>
        <p><b>Saldo:</b> $<span id="saldo"></span></p>
      </div>
    </div>
  </div>

  <!-- ABONOS -->
  <div class="card mb-3">
    <div class="card-header">ðŸ’° Registrar abono</div>
    <div class="card-body">
      <input id="valor" type="number" class="form-control mb-2" placeholder="Valor del abono">
      <input id="nota" class="form-control mb-2" placeholder="Nota (ej: MatrÃ­cula, Abono parcial)">
      <button class="btn btn-success w-100" onclick="registrarAbono()">Agregar abono</button>
    </div>
  </div>

  <div class="card">
    <div class="card-header">ðŸ“„ Historial de abonos</div>
    <table class="table table-bordered mb-0">
      <thead class="table-dark">
        <tr>
          <th>Fecha</th>
          <th>Valor</th>
          <th>Nota</th>
          <th>Usuario</th>
          <th>Rol</th>
        </tr>
      </thead>
      <tbody id="tablaAbonos"></tbody>
    </table>
  </div>

</div>

<script>
const token = localStorage.getItem('token');
if (!token) location.href = '/login';

const id = new URLSearchParams(location.search).get('id');

async function cargarFicha() {
  const res = await fetch('/api/estudiantes', {
    headers: { Authorization: 'Bearer ' + token }
  });
  const data = await res.json();
  const e = data.find(x => x.id == id);

  document.getElementById('nombre').innerText = e.nombre;
  document.getElementById('cedula').innerText = e.cedula;
  document.getElementById('curso').innerText = e.curso_nombre;
  document.getElementById('precio').innerText = e.precio_curso.toLocaleString();
  document.getElementById('saldo').innerText = e.saldo.toLocaleString();
  document.getElementById('foto').src = e.foto || 'https://via.placeholder.com/300';
}

async function cargarAbonos() {
  const res = await fetch('/api/abonos/' + id, {
    headers: { Authorization: 'Bearer ' + token }
  });
  const data = await res.json();

  tablaAbonos.innerHTML = '';
  data.forEach(a => {
    tablaAbonos.innerHTML += `
      <tr>
        <td>${new Date(a.fecha).toLocaleDateString()}</td>
        <td>$${a.valor.toLocaleString()}</td>
        <td>${a.nota}</td>
        <td>${a.usuario}</td>
        <td>${a.rol}</td>
      </tr>
    `;
  });
}

async function registrarAbono() {
  await fetch('/api/abonos', {
    method: 'POST',
    headers: {
      'Content-Type':'application/json',
      'Authorization':'Bearer ' + token
    },
    body: JSON.stringify({
      estudiante_id: id,
      valor: valor.value,
      nota: nota.value
    })
  });

  valor.value = '';
  nota.value = '';
  cargarFicha();
  cargarAbonos();
}

cargarFicha();
cargarAbonos();
</script>

</body>
</html>
