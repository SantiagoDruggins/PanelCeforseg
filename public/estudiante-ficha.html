<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Ficha del Estudiante - CEFORSEG</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>

<script>
if(!localStorage.getItem('token')){
  location.href='/login';
}
</script>

<div id="app"></div>

<script>
const token = localStorage.getItem('token');
const params = new URLSearchParams(location.search);
const id = params.get('id');

fetch('/layout.html')
  .then(r=>r.text())
  .then(html=>{
    document.getElementById('app').innerHTML = html;
    cargarFicha();
  });

async function cargarFicha(){
  const res = await fetch('/api/estudiantes/'+id,{
    headers:{ Authorization:'Bearer '+token }
  });
  const e = await res.json();

  const content = document.querySelector('.content');

  content.innerHTML = `
    <a href="/estudiantes-panel" class="btn btn-secondary mb-3">â¬… Volver</a>

    <div class="card mb-4 shadow-sm">
      <div class="card-body row g-3">
        <div class="col-md-4 text-center">
          <img src="${e.foto || ''}" class="img-fluid rounded border">
        </div>
        <div class="col-md-8">
          <h4>${e.nombre}</h4>
          <p><b>CÃ©dula:</b> ${e.cedula}</p>
        </div>
      </div>
    </div>

    <h5 class="mb-3">ðŸ“š Cursos matriculados</h5>
    <div id="listaCursos"></div>

    <div class="card mb-4 shadow-sm">
      <div class="card-body">
        <h5>ðŸ’° Registrar abono</h5>

        <select id="curso_id" class="form-select mb-2">
          <option value="">Seleccione curso</option>
        </select>

        <input id="valor" type="number" class="form-control mb-2" placeholder="Valor del abono">
        <input id="nota" class="form-control mb-2" placeholder="Nota (Ej: MatrÃ­cula, Abono parcial)">
        <button class="btn btn-success w-100" onclick="registrarAbono()">Agregar abono</button>
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="card-body p-0">
        <table class="table table-striped mb-0">
          <thead class="table-dark">
            <tr>
              <th>Fecha</th>
              <th>Curso</th>
              <th>Valor</th>
              <th>Nota</th>
              <th>Usuario</th>
              <th>Rol</th>
            </tr>
          </thead>
          <tbody id="tablaAbonos"></tbody>
        </table>
      </div>
    </div>
  `;

  renderCursos(e.cursos);
  cargarAbonos();
}

function renderCursos(cursos){
  const cont = document.getElementById('listaCursos');
  const select = document.getElementById('curso_id');
  cont.innerHTML = '';
  select.innerHTML = '<option value="">Seleccione curso</option>';

  cursos.forEach(c=>{
    cont.innerHTML += `
      <div class="card mb-3 shadow-sm">
        <div class="card-body">
          <h6>${c.nombre}</h6>
          <p><b>Precio:</b> $${Number(c.precio).toLocaleString()}</p>
          <p><b>Saldo:</b> $${Number(c.saldo).toLocaleString()}</p>
        </div>
      </div>
    `;

    select.innerHTML += `<option value="${c.curso_id}">${c.nombre}</option>`;
  });
}

async function cargarAbonos(){
  const res = await fetch('/api/abonos/'+id,{
    headers:{ Authorization:'Bearer '+token }
  });
  const abonos = await res.json();
  const tabla = document.getElementById('tablaAbonos');
  tabla.innerHTML = '';

  abonos.forEach(a=>{
    tabla.innerHTML += `
      <tr>
        <td>${new Date(a.fecha).toLocaleDateString()}</td>
        <td>${a.curso}</td>
        <td>$${Number(a.valor).toLocaleString()}</td>
        <td>${a.nota || '-'}</td>
        <td>${a.usuario || '-'}</td>
        <td>${a.rol || '-'}</td>
      </tr>
    `;
  });
}

async function registrarAbono(){
  const curso_id = document.getElementById('curso_id').value;
  const valor = document.getElementById('valor').value;
  const nota = document.getElementById('nota').value;

  if(!curso_id || !valor){
    alert('Seleccione curso y valor');
    return;
  }

  await fetch('/api/abonos',{
    method:'POST',
    headers:{
      'Content-Type':'application/json',
      'Authorization':'Bearer '+token
    },
    body: JSON.stringify({
      estudiante_id:id,
      curso_id,
      valor,
      nota
    })
  });

  document.getElementById('valor').value='';
  document.getElementById('nota').value='';
  cargarFicha();
}
</script>

</body>
</html>
