<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Cierre de Caja</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
<script>
if(!localStorage.getItem('token')) location.href='/login';
</script>

<div id="app"></div>

<script>
const token = localStorage.getItem('token');

fetch('/layout.html')
.then(r=>r.text())
.then(html=>{
  document.getElementById('app').innerHTML = html;
  const content = document.querySelector('.content');

  content.innerHTML = `
    <h3 class="mb-4">üí∞ Cierre de Caja</h3>

    <div class="row g-4 mb-4">
      <div class="col-md-4">
        <div class="card shadow">
          <div class="card-body">
            <small>Efectivo sistema</small>
            <h4 id="efectivoSistema">$0</h4>
          </div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="card shadow">
          <div class="card-body">
            <small>Nequi sistema</small>
            <h4 id="nequiSistema">$0</h4>
          </div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="card shadow">
          <div class="card-body">
            <small>Total sistema</small>
            <h4 id="totalSistema">$0</h4>
          </div>
        </div>
      </div>
    </div>

    <div class="card shadow">
      <div class="card-body">
        <h6 class="mb-3">Conteo f√≠sico</h6>

        <div class="row g-3">
          <div class="col-md-6">
            <input id="efectivoReportado" type="number" class="form-control" placeholder="Efectivo contado">
          </div>
          <div class="col-md-6">
            <input id="nequiReportado" type="number" class="form-control" placeholder="Nequi contado">
          </div>
        </div>

        <button class="btn btn-success w-100 mt-4" onclick="cerrarCaja()">
          üîí Cerrar Caja
        </button>
      </div>
    </div>
  `;

  cargarDatos();
});

async function cargarDatos(){
  const res = await fetch('/api/cierre-caja/hoy', {
    headers:{ Authorization:'Bearer '+token }
  });

  const d = await res.json();

  efectivoSistema.innerText =
    '$' + d.efectivo_sistema.toLocaleString();

  nequiSistema.innerText =
    '$' + d.nequi_sistema.toLocaleString();

  totalSistema.innerText =
    '$' + d.total_sistema.toLocaleString();
}

async function cerrarCaja(){
  const efectivo = Number(efectivoReportado.value || 0);
  const nequi = Number(nequiReportado.value || 0);

  if(!confirm('¬øConfirmar cierre de caja?')) return;

  const res = await fetch('/api/cierre-caja', {
    method:'POST',
    headers:{
      'Content-Type':'application/json',
      'Authorization':'Bearer '+token
    },
    body: JSON.stringify({
      efectivo_reportado: efectivo,
      nequi_reportado: nequi
    })
  });

  const data = await res.json();
  alert(data.mensaje);

  // üî• REFRESH AUTOM√ÅTICO DEL MINI DASHBOARD
  await cargarDatos();

  // üîí OPCIONAL: desactivar bot√≥n
  document.querySelector('button').disabled = true;
  document.querySelector('button').innerText = 'Caja cerrada';
}

</script>
</body>
</html>
