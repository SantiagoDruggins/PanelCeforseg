<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Subir Certificados - CEFORSEG</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f4f6f9; }
    .sidebar { height:100vh; background:#0a3b78; color:white; padding:20px; }
    .sidebar a { color:white; text-decoration:none; display:block; padding:10px; border-radius:4px; }
    .sidebar a:hover { background: rgba(255,255,255,0.2); }
  </style>
</head>
<body>
<div class="container-fluid">
  <div class="row">
    <div class="col-2 sidebar">
      <h4>CEFORSEG</h4><hr>
      <a href="/dashboard">ðŸ“Š Dashboard</a>
      <a href="/cursos-panel">ðŸ“š Cursos</a>
      <a href="/estudiantes-panel">ðŸ‘¥ Estudiantes</a>
      <a href="/usuarios-panel">ðŸ‘¤ Usuarios</a>
      <a href="/certificados-panel">ðŸŽ“ Certificados</a>
      <hr>
      <a href="#" id="logout">ðŸšª Cerrar sesiÃ³n</a>
    </div>

    <div class="col-10 p-4">
      <h2 class="mb-1">Subir certificados</h2>
      <p class="text-muted">Desde 2024 requiere PDF. Antes de 2024 se registra como diploma antiguo (sin PDF).</p>

      <div class="card mb-4">
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">CÃ©dula</label>
              <input id="cedula" class="form-control" placeholder="Ej: 1098606923">
            </div>
            <div class="col-md-4">
              <label class="form-label">Nombre completo</label>
              <input id="nombre" class="form-control" placeholder="Nombre del estudiante">
            </div>
            <div class="col-md-4">
              <label class="form-label">Curso</label>
              <input id="curso" class="form-control" placeholder="Ej: REENTRENAMIENTO ESCOLTA">
            </div>

            <div class="col-md-3">
              <label class="form-label">Fecha diploma</label>
              <input id="fecha" type="date" class="form-control">
            </div>

            <div class="col-md-5">
              <label class="form-label">PDF (solo si es 2024+)</label>
              <input id="archivo" type="file" accept="application/pdf" class="form-control">
            </div>

            <div class="col-md-4 d-flex align-items-end">
              <button class="btn btn-primary w-100" onclick="subir()">Guardar certificado</button>
            </div>
          </div>

          <div id="msg" class="mt-3"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-body p-0">
          <div class="p-3">
            <h5 class="mb-0">Historial</h5>
          </div>
          <table class="table table-striped mb-0">
            <thead class="table-dark">
              <tr>
                <th>ID</th>
                <th>CÃ©dula</th>
                <th>Nombre</th>
                <th>Curso</th>
                <th>Fecha</th>
                <th>Tipo</th>
                <th>PDF</th>
                <th>AcciÃ³n</th>
              </tr>
            </thead>
            <tbody id="tabla"></tbody>
          </table>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
  const token = localStorage.getItem('token');
  const rol = localStorage.getItem('rol');
  if (!token) location.href = '/login';

  function fmt(d) { return (d || '').slice(0,10); }

  async function cargar() {
    const res = await fetch('/certificados', { headers: { Authorization: 'Bearer ' + token }});
    const rows = await res.json();

    const tb = document.getElementById('tabla');
    tb.innerHTML = '';

    rows.forEach(r => {
      const pdf = r.archivo_pdf ? `<a target="_blank" href="/certificados/${r.id}/archivo?cedula=${r.cedula}">PDF</a>` : '-';
      const delBtn = (rol === 'gerente')
        ? `<button class="btn btn-sm btn-danger" onclick="borrar(${r.id})">Eliminar</button>`
        : '-';

      tb.innerHTML += `
        <tr>
          <td>${r.id}</td>
          <td>${r.cedula}</td>
          <td>${r.nombre}</td>
          <td>${r.curso}</td>
          <td>${fmt(r.fecha_diploma)}</td>
          <td>${r.tipo}</td>
          <td>${pdf}</td>
          <td>${delBtn}</td>
        </tr>
      `;
    });
  }

  async function subir() {
    const cedula = document.getElementById('cedula').value.trim();
    const nombre = document.getElementById('nombre').value.trim();
    const curso  = document.getElementById('curso').value.trim();
    const fecha  = document.getElementById('fecha').value;
    const file   = document.getElementById('archivo').files[0];

    if (!cedula || !nombre || !curso || !fecha) {
      document.getElementById('msg').innerHTML = `<div class="alert alert-danger">Faltan datos obligatorios.</div>`;
      return;
    }

    const year = parseInt(fecha.slice(0,4));
    if (year >= 2024 && !file) {
      document.getElementById('msg').innerHTML = `<div class="alert alert-warning">Desde 2024 debes adjuntar PDF.</div>`;
      return;
    }

    const fd = new FormData();
    fd.append('cedula', cedula);
    fd.append('nombre', nombre);
    fd.append('curso', curso);
    fd.append('fecha_diploma', fecha);
    if (file) fd.append('archivo', file);

    const res = await fetch('/certificados', {
      method: 'POST',
      headers: { Authorization: 'Bearer ' + token },
      body: fd
    });

    const data = await res.json();
    document.getElementById('msg').innerHTML =
      `<div class="alert ${res.ok ? 'alert-success' : 'alert-danger'}">${data.mensaje || 'Listo'}</div>`;

    if (res.ok) {
      document.getElementById('archivo').value = '';
      cargar();
    }
  }

  async function borrar(id) {
    if (!confirm('Â¿Eliminar certificado?')) return;
    const res = await fetch('/certificados/' + id, {
      method: 'DELETE',
      headers: { Authorization: 'Bearer ' + token }
    });
    const data = await res.json();
    alert(data.mensaje || 'OK');
    cargar();
  }

  document.getElementById('logout').onclick = () => {
    localStorage.clear();
    location.href = '/login';
  };

  cargar();
</script>
</body>
</html>
